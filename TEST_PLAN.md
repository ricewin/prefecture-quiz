# テスト計画書

## 1. 概要

### 1.1 アプリケーション概要
都道府県クイズは、日本の地理学習を支援するStreamlit製のWebアプリケーションです。このアプリケーションは以下の2つの主要機能を提供します：

1. **クイズモード**: 地図上に表示された県庁所在地から都道府県を当てるクイズ
2. **学習モード**: 都道府県および市町村の場所を覚えるインタラクティブな学習ページ

### 1.2 テスト計画の目的
本テスト計画書は、都道府県クイズアプリケーションの品質を保証し、ユーザーに安定した学習体験を提供するため、包括的なテスト戦略を定義します。

### 1.3 テスト対象バージョン
- バージョン: 0.1.0
- Python: 3.14以上
- Streamlit: 1.53.0以上

---

## 2. テスト対象機能

### 2.1 クイズ機能（quiz.py）
- **クイズモード選択**
  - 地図上に県庁所在地を表示して都道府県を当てるモード（map_capital_mc）
  
- **クイズフロー**
  - クイズ開始処理
  - 問題生成とランダム選択
  - 回答の入力/選択
  - 回答の正誤判定
  - スコア集計
  - 次の問題への遷移
  - 最終結果の表示

- **データ処理**
  - 都道府県名の正規化処理（県/都/府/道の除去）
  - 多肢選択問題の選択肢生成
  - セッション状態の管理

### 2.2 学習機能（study.py）
- **都道府県学習モード**
  - 都道府県の地図表示
  - 都道府県名のクイズ機能
  - ヒント表示機能
  
- **市町村学習モード**
  - 都道府県選択後の市町村表示
  - 市町村名のクイズ機能
  - 北海道の振興局対応
  - 特定地域（東京都、沖縄県）の特殊処理

- **進捗管理**
  - 正解数、不正解数の記録
  - 間違えた問題のリスト表示
  - ステップ遷移機能

### 2.3 共通機能（common/）
- **ルーティング機能**（routing.py）
  - ページ設定
  - ナビゲーション管理
  
- **データ処理機能**（utils.py）
  - GeoJSONデータの読み込み
  - 地図の中心座標計算
  - バウンディングボックス計算

- **地図表示機能**（pydeck.py）
  - PyDeckを使用した地図レンダリング
  - インタラクティブな地図操作
  - 選択イベントの処理

- **定数管理**（const.py）
  - 都道府県・県庁所在地データの管理
  - 座標データの管理

---

## 3. テストレベルとアプローチ

### 3.1 単体テスト（Unit Tests）

#### 3.1.1 テスト対象モジュール

##### quiz.py
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_normalize_name_with_suffix | 都道府県名の正規化（接尾辞あり） | 「大阪府」→「おおさか」 |
| test_normalize_name_without_suffix | 都道府県名の正規化（接尾辞なし） | 「東京」→「とうきょう」 |
| test_normalize_name_with_spaces | 空白を含む文字列の正規化 | 「千葉　県」→「ちば」 |
| test_normalize_name_none | None値の処理 | 空文字列を返す |
| test_normalize_name_empty | 空文字列の処理 | 空文字列を返す |
| test_quiz_initialization | クイズの初期化 | セッション状態が正しく設定される |
| test_generate_mc_options | 選択肢の生成 | 正解+3つの不正解が生成される |
| test_mc_options_uniqueness | 選択肢の重複チェック | 4つの選択肢が全て異なる |

##### utils.py
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_load_data_success | データファイルの正常読み込み | GeoJSONデータが返される |
| test_load_data_file_not_found | 存在しないファイルの読み込み | FileNotFoundErrorが発生 |
| test_get_geojson_center_polygon | Polygon型のGeoJSONの中心計算 | 正しい緯度経度が返される |
| test_get_geojson_center_multipolygon | MultiPolygon型の中心計算 | 正しい緯度経度が返される |
| test_get_geojson_center_empty | 空のGeoJSON | ValueErrorが発生 |
| test_get_geojson_center_none_geometry | geometry=Noneのケース | スキップして処理が続く |
| test_get_geojson_bbox | バウンディングボックスの計算 | 正しい範囲が返される |

##### const.py
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_prefectures_count | 都道府県データの件数 | 47都道府県存在する（重複を除く） |
| test_prefecture_data_format | データフォーマットの確認 | (都道府県名, 市町村名, 緯度, 経度)の形式 |
| test_coordinate_range | 座標の範囲チェック | 緯度: 24-46, 経度: 123-154の範囲内 |
| test_num_questions | クイズ問題数の設定 | デフォルト値が10 |

##### step_by_step.py
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_initialize_state | 初期状態の設定 | now=0, rst=Falseが設定される |
| test_countup | ステップカウントアップ | nowが1増加する |
| test_countdown | ステップカウントダウン | nowが1減少する |
| test_reset | リセット処理 | now=0に戻る |
| test_change_state | 状態変更処理 | セッション状態がクリアされる |

#### 3.1.2 テスト実行方法
```bash
# pytestを使用した単体テストの実行
pytest tests/ -v

# カバレッジ計測付きの実行
pytest tests/ --cov=app --cov-report=html

# 特定のテストファイルのみ実行
pytest tests/test_quiz.py -v
```

### 3.2 統合テスト（Integration Tests）

#### 3.2.1 テスト対象

##### クイズフロー統合テスト
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_quiz_flow_complete | クイズ開始から終了まで | 正常にクイズが完了する |
| test_quiz_score_calculation | スコア計算の正確性 | 正解数が正しく集計される |
| test_quiz_state_transitions | 状態遷移の正確性 | クイズ状態が適切に遷移する |
| test_quiz_session_persistence | セッション永続性 | セッション状態が保持される |

##### 学習モード統合テスト
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_study_mode_prefecture | 都道府県学習モード | 正常に動作する |
| test_study_mode_municipality | 市町村学習モード | 都道府県選択後に動作する |
| test_study_mode_hokkaido | 北海道の特殊処理 | 振興局/市町村の切り替えが動作 |
| test_study_mode_progress_tracking | 進捗追跡 | 正解/不正解が正しく記録される |

##### データ処理統合テスト
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_data_loading_and_map_display | データ読み込みと地図表示 | GeoJSONが正しく地図に表示される |
| test_map_interaction | 地図のインタラクション | クリックイベントが正しく処理される |
| test_tooltip_display | ツールチップ表示 | ホバー時に正しい情報が表示される |

#### 3.2.2 テスト実行方法
```bash
# 統合テストの実行
pytest tests/integration/ -v

# 統合テストとE2Eテストの実行
pytest tests/integration/ tests/e2e/ -v
```

### 3.3 UIテスト / E2Eテスト

#### 3.3.1 テスト対象

##### クイズUI操作テスト
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_quiz_start_button | スタートボタンのクリック | クイズが開始される |
| test_quiz_mode_selection | モード選択ラジオボタン | モードが正しく選択される |
| test_quiz_answer_submission | 回答送信 | 正誤判定が表示される |
| test_quiz_next_button | 次へボタン | 次の問題に遷移する |
| test_quiz_result_display | 結果画面表示 | スコアと詳細が表示される |
| test_quiz_restart | 再スタート | スタート画面に戻る |

##### 学習UI操作テスト
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_study_hint_toggle | ヒント表示切り替え | ヒントの表示/非表示が切り替わる |
| test_study_map_selection | 地図上の領域選択 | 選択した領域が認識される |
| test_study_answer_button | 答えるボタン | 正誤判定が表示される |
| test_study_change_button | チェンジボタン | 問題が変更される |
| test_study_reset_button | リセットボタン | 進捗がリセットされる |
| test_study_prefecture_selection | 都道府県選択 | 市町村モードに遷移する |

##### ナビゲーションテスト
| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_navigation_quiz_page | クイズページへの遷移 | クイズページが表示される |
| test_navigation_study_page | 学習ページへの遷移 | 学習ページが表示される |
| test_navigation_page_state | ページ遷移時の状態保持 | 各ページの状態が保持される |

#### 3.3.2 テスト実行方法
```bash
# Streamlitテスト用のツールを使用
# streamlit-app-testingを使用する場合
pytest tests/e2e/ -v

# 手動テストチェックリストを使用する場合
# TEST_CHECKLIST.mdを参照
```

### 3.4 パフォーマンステスト

#### 3.4.1 テスト項目

| テストケース | 測定指標 | 目標値 |
|------------|---------|-------|
| test_page_load_time | ページ読み込み時間 | 3秒以内 |
| test_quiz_start_time | クイズ開始処理時間 | 1秒以内 |
| test_map_render_time | 地図レンダリング時間 | 2秒以内 |
| test_data_load_time | GeoJSONデータ読み込み | 1秒以内 |
| test_memory_usage | メモリ使用量 | 500MB以内 |

#### 3.4.2 負荷テスト

| テストケース | 条件 | 期待結果 |
|------------|------|---------|
| test_concurrent_users | 同時ユーザー数: 10人 | 応答時間の大幅な劣化がない |
| test_session_management | 複数セッションの管理 | セッション間でデータが混在しない |

### 3.5 セキュリティテスト

#### 3.5.1 テスト項目

| テストケース | テスト内容 | 期待結果 |
|------------|----------|---------|
| test_input_validation | 入力値の検証 | 不正な入力が適切に処理される |
| test_xss_protection | XSS攻撃対策 | スクリプト注入が防止される |
| test_data_sanitization | データのサニタイズ | ユーザー入力が適切にエスケープされる |
| test_file_access | ファイルアクセス制御 | 許可されたファイルのみアクセス可能 |

---

## 4. テストデータ

### 4.1 テストデータセット

#### 都道府県データ
- **正常系データ**: `const.py`に定義された47都道府県の完全なデータセット
- **異常系データ**: 
  - 存在しない都道府県名
  - 不正な座標データ
  - 欠損データ

#### GeoJSONテストデータ
- **最小限のGeoJSON**: 単一のPolygonを含むデータ
- **複雑なGeoJSON**: MultiPolygonを含むデータ
- **空のGeoJSON**: featuresが空の配列
- **不正なGeoJSON**: フォーマットエラーを含むデータ

### 4.2 モックデータ

#### Streamlitセッション状態のモック
```python
# セッション状態のモック例
mock_session_state = {
    "quiz": [...],  # クイズデータ
    "index": 0,
    "score": 0,
    "answered": [None] * 10,
    "show_answer": False,
    "mode": "map_capital_mc"
}
```

---

## 5. テスト環境

### 5.1 開発環境
- OS: Linux（Ubuntu 20.04以上）/ macOS / Windows
- Python: 3.14以上
- パッケージマネージャー: uv
- 主要ライブラリ: Streamlit 1.53.0以上、pydeck、pandas

### 5.2 テスト環境
- 継続的インテグレーション: GitHub Actions
- テストフレームワーク: pytest
- カバレッジツール: pytest-cov
- Linter: ruff

### 5.3 ブラウザ互換性テスト
| ブラウザ | バージョン | 優先度 |
|---------|----------|-------|
| Chrome | 最新版 | 高 |
| Firefox | 最新版 | 高 |
| Safari | 最新版 | 中 |
| Edge | 最新版 | 中 |

### 5.4 画面解像度テスト
| 解像度 | デバイスタイプ | 優先度 |
|-------|-------------|-------|
| 1920x1080 | デスクトップ | 高 |
| 1366x768 | ノートPC | 高 |
| 768x1024 | タブレット（縦） | 中 |
| 375x667 | スマートフォン | 低 |

---

## 6. テスト実施スケジュール

### 6.1 テスト計画フェーズ

| フェーズ | タスク | 期間 |
|---------|-------|------|
| 計画立案 | テスト計画書作成 | 2日 |
| テスト設計 | テストケース設計 | 3日 |
| テスト準備 | テスト環境構築、データ準備 | 2日 |

### 6.2 テスト実施フェーズ

| フェーズ | タスク | 期間 |
|---------|-------|------|
| 単体テスト | 各モジュールの単体テスト実施 | 5日 |
| 統合テスト | 統合テストの実施 | 3日 |
| UIテスト | E2Eテストの実施 | 3日 |
| パフォーマンステスト | 負荷・パフォーマンステスト | 2日 |
| セキュリティテスト | セキュリティテスト | 2日 |
| 回帰テスト | 全テストの再実行 | 2日 |

### 6.3 テスト完了フェーズ

| フェーズ | タスク | 期間 |
|---------|-------|------|
| バグ修正 | 検出されたバグの修正 | 可変 |
| 再テスト | 修正箇所の再テスト | 可変 |
| レポート作成 | テスト結果レポート作成 | 1日 |

---

## 7. 合格基準

### 7.1 単体テスト
- すべての単体テストが成功する
- コードカバレッジ: 80%以上

### 7.2 統合テスト
- すべての統合テストが成功する
- 主要なユーザーフローが問題なく動作する

### 7.3 UIテスト
- すべての画面が正しく表示される
- すべてのインタラクティブ要素が正しく動作する
- ブラウザ互換性テストで致命的なエラーがない

### 7.4 パフォーマンステスト
- ページ読み込み時間が目標値以内
- 同時ユーザー数テストで問題が発生しない

### 7.5 セキュリティテスト
- 致命的なセキュリティ脆弱性がゼロ
- 入力検証が適切に機能する

### 7.6 リリース条件
- すべての優先度「高」のテストが成功
- 優先度「中」のテストで未解決の問題が5件以下
- 優先度「低」のテストで未解決の問題が10件以下
- リリースブロッカーとなる致命的なバグがゼロ

---

## 8. リスク管理

### 8.1 リスク評価

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| GeoJSONデータの破損 | 高 | 低 | データ検証処理の追加、バックアップ |
| セッション状態の不整合 | 高 | 中 | 状態管理の厳格化、リセット機能の実装 |
| ブラウザ互換性問題 | 中 | 中 | 複数ブラウザでのテスト実施 |
| パフォーマンス劣化 | 中 | 低 | キャッシング機能の活用 |
| 外部ライブラリの更新 | 低 | 高 | 定期的な依存関係のチェック |

### 8.2 リスク対応戦略
- **回避**: 既知の問題があるライブラリバージョンを使用しない
- **軽減**: キャッシング機能を活用してパフォーマンスを向上
- **転嫁**: Streamlitのエラーハンドリング機能を活用
- **受容**: 低優先度のブラウザでの軽微な表示問題は許容

---

## 9. テストメトリクス

### 9.1 収集するメトリクス
- テストケース総数
- 実行されたテストケース数
- 成功したテストケース数
- 失敗したテストケース数
- スキップされたテストケース数
- コードカバレッジ
- 検出されたバグ数（重要度別）
- バグ修正率
- テスト実行時間

### 9.2 品質ゴール
- テスト成功率: 95%以上
- コードカバレッジ: 80%以上
- 致命的バグ: 0件
- 重大バグ: 5件以下
- 平均バグ修正時間: 2日以内

---

## 10. テストツールとフレームワーク

### 10.1 使用ツール

| ツール | 用途 | 理由 |
|-------|------|------|
| pytest | テスト実行 | Pythonの標準的なテストフレームワーク |
| pytest-cov | カバレッジ測定 | pytestと統合されたカバレッジツール |
| pytest-mock | モック作成 | セッション状態やStreamlitコンポーネントのモック化 |
| ruff | Linting | 高速で設定可能なPython linter |
| Pyright | 型チェック | 静的型検査 |

### 10.2 CI/CD統合
```yaml
# GitHub Actionsの例
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.14'
      - name: Install dependencies
        run: |
          pip install uv
          uv sync
      - name: Run tests
        run: pytest tests/ -v --cov=app
      - name: Run linter
        run: ruff check app/
```

---

## 11. バグ管理

### 11.1 バグの重要度分類

| 重要度 | 説明 | 例 |
|-------|------|---|
| 致命的 | アプリケーションが使用不可 | アプリが起動しない、データ破損 |
| 重大 | 主要機能が動作しない | クイズが開始できない、スコアが記録されない |
| 中程度 | 機能は動作するが問題がある | UI表示の乱れ、遅延 |
| 軽微 | ユーザー体験に小さな影響 | 文言の誤字、軽微なレイアウト問題 |
| 提案 | 改善提案 | 機能追加の提案 |

### 11.2 バグトラッキング
- GitHub Issuesを使用してバグを管理
- バグには適切なラベル（bug, enhancement, documentation等）を付与
- 優先度と重要度を明記

---

## 12. テストドキュメント

### 12.1 作成するドキュメント
- テスト計画書（本ドキュメント）
- テストケース仕様書
- テスト実施記録
- テスト結果レポート
- 既知の問題リスト

### 12.2 ドキュメント管理
- すべてのドキュメントはGitリポジトリで管理
- バージョン管理を実施
- 定期的なレビューと更新

---

## 13. 成功基準と完了定義

### 13.1 テストフェーズの完了定義
- すべての計画されたテストが実施された
- すべての致命的および重大なバグが修正された
- コードカバレッジが目標値に達している
- テストレポートが作成され、レビューされた

### 13.2 プロジェクトの成功基準
- 合格基準（セクション7）をすべて満たしている
- ステークホルダーの承認が得られた
- 本番環境へのデプロイ準備が整っている

---

## 14. 参考資料

### 14.1 関連ドキュメント
- README.md: アプリケーション概要
- pyproject.toml: プロジェクト設定
- 国土交通省国土数値情報: データソース

### 14.2 参考リンク
- [Streamlit Documentation](https://docs.streamlit.io/)
- [pytest Documentation](https://docs.pytest.org/)
- [Python Testing Best Practices](https://docs.python-guide.org/writing/tests/)

---

## 15. 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|-------|
| 1.0 | 2026-01-25 | 初版作成 | テスト計画チーム |

---

## 付録A: テストケース詳細テンプレート

```markdown
### テストケースID: TC001
- **テスト項目**: 都道府県名の正規化
- **前提条件**: アプリケーションが起動している
- **テスト手順**:
  1. normalize_name関数を呼び出す
  2. 入力値として「大阪府」を渡す
- **期待結果**: 「おおさか」が返される
- **実際の結果**: 
- **合否**: 
- **備考**: 
```

---

## 付録B: 手動テストチェックリスト

### クイズモード手動テスト
- [ ] アプリケーションが正常に起動する
- [ ] スタートボタンが表示される
- [ ] モード選択ができる
- [ ] クイズが開始される
- [ ] 地図が正しく表示される
- [ ] 選択肢が4つ表示される
- [ ] 回答を選択できる
- [ ] 回答するボタンが機能する
- [ ] 正誤判定が表示される
- [ ] スコアが正しく表示される
- [ ] 次へボタンで次の問題に進む
- [ ] 10問完了後に結果画面が表示される
- [ ] スタート画面に戻れる

### 学習モード手動テスト
- [ ] 学習ページに遷移できる
- [ ] 都道府県の地図が表示される
- [ ] ヒント表示/非表示が切り替わる
- [ ] 地図上の都道府県をクリックできる
- [ ] 答えるボタンが機能する
- [ ] 正解/不正解が判定される
- [ ] 正解数が正しく表示される
- [ ] 間違えた問題が記録される
- [ ] チェンジボタンで問題が変わる
- [ ] リセットボタンで進捗がリセットされる
- [ ] 都道府県選択後に市町村モードに進める
- [ ] 北海道選択時に振興局/市町村の切り替えができる

---

**本テスト計画書は、都道府県クイズアプリケーションの品質保証活動の基盤となる文書です。**
**定期的に見直し、必要に応じて更新してください。**
